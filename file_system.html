<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æª”æ¡ˆç®¡ç†ç³»çµ± - éœ€æ±‚åˆ†æèˆ‡è¨­è¨ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨æ¨™æº– Script è¼‰å…¥ Mermaid ä»¥ç¢ºä¿å…¨åŸŸå­˜å–ç©©å®šæ€§ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        .tree-node { margin-left: 20px; border-left: 1px dashed #ccc; padding-left: 10px; position: relative; }
        .file-icon { color: #6b7280; }
        .folder-icon { color: #f59e0b; }
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        .tab-btn.active { 
            border-bottom: 4px solid #1e40af; 
            color: #1e40af; 
            font-weight: 700;
        }
        .mermaid { min-height: 250px; display: flex; justify-content: center; }
        .control-panel { background: #f8fafc; border: 1px solid #e2e8f0; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .tree-item-row:hover .delete-btn { opacity: 1; }
        #terminal-output { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans leading-relaxed">

    <div class="max-w-5xl mx-auto py-12 px-6">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-4">é›²ç«¯æª”æ¡ˆç®¡ç†ç³»çµ±åˆ†æèˆ‡è¨­è¨ˆ</h1>
            <p class="text-lg text-gray-600">ç³»çµ±åˆ†æå¸«ï¼šGemini | ä¿®æ­£å¾Œçš„è³‡æ–™åº«æ¶æ§‹èˆ‡å¯¦ä½œ</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-8 sticky top-0 bg-gray-50 z-20">
            <button onclick="openTab(event, 'arch')" class="tab-btn active px-6 py-3 text-gray-500 hover:text-blue-600 transition-all focus:outline-none">ç³»çµ±æ¶æ§‹</button>
            <button onclick="openTab(event, 'domain')" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 transition-all focus:outline-none">é ˜åŸŸæ¨¡å‹ (UML)</button>
            <button onclick="openTab(event, 'er')" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 transition-all focus:outline-none">è³‡æ–™åº«è¨­è¨ˆ (ERD)</button>
            <button onclick="openTab(event, 'demo')" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 transition-all focus:outline-none">ç³»çµ± Demo</button>
        </div>

        <!-- 1. ç³»çµ±æ¶æ§‹èªªæ˜ -->
        <div id="arch" class="tab-content active">
            <section class="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-2xl font-bold border-b-2 border-blue-500 pb-2 mb-6">1. æ ¸å¿ƒè¨­è¨ˆè¦ç¯„</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-blue-700">ä¿®æ­£å¾Œçš„è³‡æ–™åº«æ€è·¯</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li><strong>æ­£è¦åŒ–å¯¦é«”</strong>ï¼šé€é `USERS` èˆ‡ `NODES` çš„é—œè¯å¯¦ä½œæ¬Šé™åŸºç¤ã€‚</li>
                            <li><strong>é«˜æ“´å……æ€§</strong>ï¼šæ¡ç”¨ TPT æ¨¡å¼ï¼Œæœªä¾†è‹¥æ–°å¢ã€Œå½±ç‰‡ã€æˆ–ã€ŒéŸ³æ¨‚ã€é¡å‹ï¼Œåªéœ€å¢åŠ å…ƒæ•¸æ“šè¡¨ï¼Œä¸å½±éŸ¿æ ¸å¿ƒè¡¨çµæ§‹ã€‚</li>
                            <li><strong>éšå±¤å„ªåŒ–</strong>ï¼š`NODES` è¡¨çš„ `parent_id` å»ºç«‹ç´¢å¼•ï¼Œå„ªåŒ–éè¿´è®€å–æ•ˆèƒ½ã€‚</li>
                        </ul>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 text-blue-800">æ¥­å‹™è¦å‰‡æ‘˜è¦</h3>
                        <p class="text-sm">
                            ç³»çµ±æ”¯æ´ç„¡é™å±¤ç´šç›®éŒ„ã€‚æª”æ¡ˆç¸½å¤§å°ç‚ºå…¶æ‰€åœ¨ç¯€é»æ‰€æœ‰å­é …ç›®çš„æ¬Šé‡ç¸½å’Œã€‚XML åŒ¯å‡ºæ”¯æ´æ¨™æº–æ¨™ç±¤å®šç¾©ï¼Œä¾¿æ–¼è·¨å¹³å°æ•´åˆã€‚
                        </p>
                    </div>
                </div>
            </section>
        </div>

        <!-- 2. Domain Model (UML) -->
        <div id="domain" class="tab-content">
            <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-2xl font-bold border-b-2 border-blue-500 pb-2 mb-6">2. é ˜åŸŸæ¨¡å‹ (Domain Model)</h2>
                
                <!-- åŸå§‹è¨­è¨ˆ -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">ğŸ“‹ è¨­è¨ˆæ–¹å¼ 1: åŸºæœ¬æ¨¹ç‹€çµæ§‹ (Composite Pattern)</h3>
                    <div class="overflow-x-auto py-4">
                        <pre class="mermaid">
classDiagram
    class Node {
        &lt;&lt;abstract&gt;&gt;
        +UUID id
        +String name
        +DateTime created_at
        +get_display_name() String
        +toXML() String
        +getTotalSize() long
    }

    class Folder {
        +List~Node~ children
        +add_child(Node node)
        +remove_child(UUID id)
        +find_by_extension(String ext) List~Node~
    }

    class File {
        &lt;&lt;abstract&gt;&gt;
        +long size_bytes
        +get_size_display() String
    }

    class WordDocument { +int pages }
    class ImageFile { +int width, int height }
    class TextFile { +String encoding }

    Node <|-- Folder
    Node <|-- File
    File <|-- WordDocument
    File <|-- ImageFile
    File <|-- TextFile
    Folder "1" o-- "*" Node : contains
                        </pre>
                    </div>
                </div>

                <!-- Visitor Pattern è¨­è¨ˆ -->
                <div>
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">âœ¨ è¨­è¨ˆæ–¹å¼ 2: Visitor Pattern (è¨ªå•è€…æ¨¡å¼)</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        ä½¿ç”¨ Visitor Pattern å¯ä»¥å°‡ä¸åŒçš„æ“ä½œï¼ˆå¦‚å¤§å°è¨ˆç®—ã€æœå°‹ã€åŒ¯å‡ºç­‰ï¼‰èˆ‡è³‡æ–™çµæ§‹åˆ†é›¢ï¼Œ
                        ä½¿å¾—æ–°å¢æ“ä½œæ™‚ç„¡éœ€ä¿®æ”¹ç¾æœ‰çš„ç¯€é»é¡åˆ¥ã€‚æ¯å€‹è¨ªå•è€…è² è²¬ç‰¹å®šæ“ä½œçš„é‚è¼¯ã€‚
                    </p>
                    <div class="overflow-x-auto py-4">
                        <pre class="mermaid">
classDiagram
    class SystemEntryComponent {
        &lt;&lt;abstract&gt;&gt;
        +String name
        +DateTime created
        +int size
        +String attributes
        +abstract String type
        +abstract void accept(IVisitor visitor)
    }

    class FileLeaf {
        &lt;&lt;abstract&gt;&gt;
        +void accept(IVisitor visitor)
    }

    class DirectoryComposite {
        -List~SystemEntryComponent~ children
        +void add(SystemEntryComponent child)
        +void remove(SystemEntryComponent child)
        +SystemEntryComponent[] getChildren()
        +String type
        +void accept(IVisitor visitor)
    }

    class WordDocumentLeaf {
        +int pages
    }
    class ImageFileLeaf {
        +int width
        +int height
    }
    class TextFileLeaf {
        +String encoding
    }

    class IVisitor {
        &lt;&lt;interface&gt;&gt;
        +void visit(FileLeaf leaf)
        +void visit(DirectoryComposite composite)
    }

    class SizeCalculatorVisitor {
        -long totalSize
        +void visit(FileLeaf leaf)
        +void visit(DirectoryComposite composite)
        +long getTotalSize()
    }

    class FileSearchVisitor {
        -String extension
        -List~FileLeaf~ results
        +void visit(FileLeaf leaf)
        +void visit(DirectoryComposite composite)
        +List~FileLeaf~ getResults()
    }

    class XMLExportVisitor {
        -String xmlOutput
        +void visit(FileLeaf leaf)
        +void visit(DirectoryComposite composite)
        +String getXMLOutput()
    }

    SystemEntryComponent <|-- FileLeaf
    SystemEntryComponent <|-- DirectoryComposite
    FileLeaf <|-- WordDocumentLeaf
    FileLeaf <|-- ImageFileLeaf
    FileLeaf <|-- TextFileLeaf
    DirectoryComposite "1" o-- "*" SystemEntryComponent : contains
    IVisitor <|-- SizeCalculatorVisitor
    IVisitor <|-- FileSearchVisitor
    IVisitor <|-- XMLExportVisitor
    SystemEntryComponent --> IVisitor : accept
                        </pre>
                    </div>
                    
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-bold text-blue-700 mb-2">ğŸ’¡ Visitor Pattern çš„å„ªå‹¢ï¼š</h4>
                        <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                            <li><strong>é–‹æ”¾å°é–‰åŸå‰‡</strong>ï¼šæ–°å¢æ“ä½œæ™‚ç„¡éœ€ä¿®æ”¹ç¯€é»é¡åˆ¥ï¼Œåªéœ€æ–°å¢ Visitor å¯¦ä½œ</li>
                            <li><strong>è·è²¬åˆ†é›¢</strong>ï¼šè³‡æ–™çµæ§‹èˆ‡æ“ä½œé‚è¼¯å®Œå…¨åˆ†é›¢ï¼Œä»£ç¢¼æ›´æ˜“ç¶­è­·</li>
                            <li><strong>æ“´å±•æ€§å¼·</strong>ï¼šæ”¯æ´çµ±è¨ˆã€æœå°‹ã€é©—è­‰ã€å‚™ä»½ç­‰å¤šç¨®æ“ä½œï¼Œæ¯å€‹éƒ½æ˜¯ç¨ç«‹çš„ Visitor</li>
                            <li><strong>é›™é‡åˆ†æ´¾</strong>ï¼šæ ¹æ“šè¨ªå•è€…å’Œç¯€é»çš„å…·é«”é¡å‹æ±ºå®šåŸ·è¡Œçš„æ–¹æ³•</li>
                            <li><strong>ç°¡æ½”è¨­è¨ˆ</strong>ï¼šVisitor æ¥å£åªéœ€å…©å€‹ Visit æ–¹æ³•ï¼ˆè‘‰å­ã€è¤‡åˆç¯€é»ï¼‰</li>
                        </ul>
                    </div>

                    <div class="mt-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <h4 class="font-bold text-amber-700 mb-2">ğŸ“ å¯¦ä½œé—œéµï¼š</h4>
                        <pre class="text-xs bg-white p-2 rounded border border-amber-100 overflow-x-auto"><code>// åŸºç¤å…ƒä»¶å®šç¾© accept æ–¹æ³•
abstract class SystemEntryComponent {
    abstract void accept(IVisitor visitor)
}

// è‘‰å­ç¯€é»å¯¦ä½œ
abstract class FileLeaf extends SystemEntryComponent {
    void accept(IVisitor visitor) {
        visitor.visit(this)
    }
}

// è¤‡åˆç¯€é»å¯¦ä½œ
class DirectoryComposite extends SystemEntryComponent {
    List children = []
    
    void accept(IVisitor visitor) {
        visitor.visit(this)  // è¨ªå•è‡ªèº«
        children.forEach(child => child.accept(visitor))  // éè¿´è¨ªå•å­ç¯€é»
    }
}

// è¨ªå•è€…æ¥å£ - ç°¡æ½”è¨­è¨ˆ
interface IVisitor {
    void visit(FileLeaf leaf)        // è™•ç†æ‰€æœ‰æª”æ¡ˆé¡å‹
    void visit(DirectoryComposite composite)  // è™•ç†ç›®éŒ„
}</code></pre>
                    </div>
                </div>
            </section>
        </div>

        <!-- 3. ER Diagram (ä¿®æ­£å¾Œçš„è¨­è¨ˆ) -->
        <div id="er" class="tab-content">
            <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-2xl font-bold border-b-2 border-blue-500 pb-2 mb-6">3. ä¿®æ­£å¾Œçš„è³‡æ–™åº«è¨­è¨ˆ (ER Diagram)</h2>
                <div class="overflow-x-auto py-4">
                    <pre class="mermaid">
erDiagram
    USERS ||--o{ NODES : "owns"
    NODES ||--o{ NODES : "contains (parent_id)"
    NODES ||--o| FILES : "specializes"
    FILES ||--o| WORD_DOCS : "is_type"
    FILES ||--o| IMAGE_FILES : "is_type"
    FILES ||--o| TEXT_FILES : "is_type"

    USERS {
        uuid id PK
        string username "ä½¿ç”¨è€…åç¨±"
        string email "é›»å­éƒµä»¶"
    }

    NODES {
        uuid id PK
        uuid parent_id FK "çˆ¶ç¯€é» ID"
        uuid owner_id FK "æ“æœ‰è€… ID"
        string name "åç¨±"
        enum node_type "FOLDER, FILE"
        datetime created_at
        datetime updated_at
    }

    FILES {
        uuid node_id PK, FK "é—œè¯è‡³ NODES"
        bigint size_bytes "æª”æ¡ˆå¤§å°"
        string checksum "æ ¡é©—ç¢¼"
    }

    WORD_DOCS {
        uuid file_id PK, FK
        int page_count "é æ•¸"
        string author "ä½œè€…"
    }

    IMAGE_FILES {
        uuid file_id PK, FK
        int width "åƒç´ å¯¬"
        int height "åƒç´ é«˜"
        string color_space "å¦‚ RGB"
    }

    TEXT_FILES {
        uuid file_id PK, FK
        string encoding "å¦‚ UTF-8"
        boolean has_bom "æ˜¯å¦æœ‰ BOM"
    }
                    </pre>
                </div>
                <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-100">
                    <h4 class="font-bold text-gray-700 mb-2">ä¿®æ­£é‡é»è§£æï¼š</h4>
                    <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                        <li><strong>å¯¦é«”åŒ–ä½¿ç”¨è€…</strong>ï¼šæª”æ¡ˆç³»çµ±ä¸å†æ˜¯å­¤ç«‹çš„ï¼Œç¾åœ¨æ¯å€‹ç¯€é»éƒ½æœ‰æ˜ç¢ºçš„ `owner_id`ã€‚</li>
                        <li><strong>è§£æ±ºç©ºå€¼å•é¡Œ</strong>ï¼šé€é `FILES` ä¸­ä»‹è¡¨èˆ‡å„ `_METADATA` è¡¨çš„ 1:1 é—œè¯ï¼Œè³‡æ–™åº«ä¸­ä¸å†æœ‰å¤§é‡çš„ NULL æ¬„ä½ã€‚</li>
                        <li><strong>ç¶­è­·ä¸€è‡´æ€§</strong>ï¼šå°‡ `updated_at` ç¨ç«‹å‡ºä¾†ï¼Œæ–¹ä¾¿è¿½è¹¤è³‡æ–™å¤¾å…§å®¹çš„æœ€å¾Œè®Šå‹•æ™‚é–“ã€‚</li>
                    </ul>
                </div>
            </section>
        </div>

        <!-- 4. ç³»çµ±å¯¦ä½œèˆ‡ Demo -->
        <div id="demo" class="tab-content">
            <section class="space-y-6">
                <!-- äº’å‹•æ§åˆ¶é¢æ¿ -->
                <div class="control-panel p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-bold mb-4 text-blue-800 flex items-center">
                        <span class="mr-2">ğŸ› ï¸</span> äº’å‹•æ§åˆ¶é¢æ¿
                    </h3>
                    
                    <!-- æ–°å¢åŠŸèƒ½åˆ— -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">æ–°å¢è‡³è³‡æ–™å¤¾</label>
                            <select id="parent-select" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">ç‰©ä»¶é¡å‹</label>
                            <select id="type-select" onchange="toggleFields()" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="FOLDER">ğŸ“ è³‡æ–™å¤¾</option>
                                <option value="WORD">ğŸ“„ Word æª”æ¡ˆ</option>
                                <option value="IMAGE">ğŸ–¼ï¸ åœ–ç‰‡æª”æ¡ˆ</option>
                                <option value="TEXT">ğŸ“„ ç´”æ–‡å­—æª”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">åç¨±</label>
                            <div class="flex gap-2">
                                <input type="text" id="node-name" placeholder="åç¨±" class="flex-grow p-2 border border-gray-300 rounded text-sm">
                                <button onclick="handleAddNode()" class="bg-blue-600 text-white px-4 rounded text-sm font-bold">æ–°å¢</button>
                            </div>
                        </div>
                    </div>

                    <!-- é€²éšæ“ä½œæŒ‰éˆ•åˆ— -->
                    <div class="border-t border-gray-200 pt-4 mt-2">
                        <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-widest">é€²éšåˆ†æåŠŸèƒ½</label>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="showTotalSize()" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm transition-colors">
                                ğŸ“Š è¨ˆç®—ç¸½å¤§å°
                            </button>
                            <button onclick="findDocxFiles()" class="bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm transition-colors">
                                ğŸ” æ‰¾å°‹ .docx æª”æ¡ˆ
                            </button>
                            <button onclick="exportToXML()" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm transition-colors">
                                ğŸ“œ åŒ¯å‡º XML æ ¼å¼
                            </button>
                            <button onclick="refreshUI()" class="bg-gray-500 hover:bg-gray-600 text-white text-xs font-bold py-2 px-4 rounded shadow-sm transition-colors ml-auto">
                                ğŸ”„ é‚„åŸçµæ§‹æª¢è¦–
                            </button>
                        </div>
                    </div>

                    <!-- ç‰¹æ®Šæ¬„ä½ -->
                    <div id="extra-fields" class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4 hidden p-3 bg-blue-50 rounded">
                        <div id="field-pages">
                            <label class="block text-xs font-bold text-gray-500 mb-1">é æ•¸</label>
                            <input type="number" id="node-pages" value="1" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div id="field-width" class="hidden">
                            <label class="block text-xs font-bold text-gray-500 mb-1">å¯¬åº¦</label>
                            <input type="number" id="node-width" value="1920" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div id="field-height" class="hidden">
                            <label class="block text-xs font-bold text-gray-500 mb-1">é«˜åº¦</label>
                            <input type="number" id="node-height" value="1080" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div id="field-encoding" class="hidden">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ç·¨ç¢¼</label>
                            <select id="node-encoding" class="w-full p-2 border rounded text-sm">
                                <option value="UTF-8">UTF-8</option>
                                <option value="ASCII">ASCII</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">å¤§å° (B)</label>
                            <input type="number" id="node-size" value="1024" class="w-full p-2 border rounded text-sm">
                        </div>
                    </div>
                </div>

                <!-- çµæœå‘ˆç¾ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 id="terminal-title" class="text-sm font-bold mb-3 text-gray-400 uppercase tracking-widest">çµ‚ç«¯æ©Ÿè¼¸å‡º</h3>
                        <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-x-auto border-l-4 border-green-500 h-96 shadow-inner">
                            <pre id="terminal-output">// ç³»çµ±æº–å‚™å°±ç·’...</pre>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-bold mb-3 text-gray-400 uppercase tracking-widest">è¦–è¦ºåŒ–çµæ§‹åœ–</h3>
                        <div id="tree-visual" class="space-y-1 bg-gray-50 p-4 rounded-lg border border-gray-100 h-96 overflow-y-auto shadow-inner text-sm"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });

        // ========== Visitor Pattern è¨­è¨ˆ ==========
        // åŸºç¤å…ƒä»¶æŠ½è±¡é¡
        class SystemEntryComponent {
            constructor(name) {
                this.id = crypto.randomUUID();
                this.name = name;
                this.created = new Date();
                this.size = 0;
                this.attributes = "";
            }
            get type() { throw new Error("Method not implemented."); }
            accept(visitor) { throw new Error("Method not implemented."); }
            getSizeDisplay() {
                if (this.size < 1024) return `${this.size} B`;
                return `${(this.size / 1024).toFixed(1)} KB`;
            }
        }

        // æ–‡ä»¶è‘‰å­ç¯€é»æŠ½è±¡é¡
        class FileLeaf extends SystemEntryComponent {
            constructor(name, size_bytes) {
                super(name);
                this.size = size_bytes;
            }
            accept(visitor) {
                visitor.visit(this);
            }
        }

        // å…·é«”æ–‡ä»¶é¡å‹
        class WordDocumentLeaf extends FileLeaf {
            constructor(name, size_bytes, pages) {
                super(name, size_bytes);
                this.pages = pages;
            }
            get type() { return "Word æª”æ¡ˆ"; }
        }

        class ImageFileLeaf extends FileLeaf {
            constructor(name, size_bytes, width, height) {
                super(name, size_bytes);
                this.width = width;
                this.height = height;
            }
            get type() { return "åœ–ç‰‡"; }
        }

        class TextFileLeaf extends FileLeaf {
            constructor(name, size_bytes, encoding) {
                super(name, size_bytes);
                this.encoding = encoding;
            }
            get type() { return "ç´”æ–‡å­—æª”"; }
        }

        // ç›®éŒ„è¤‡åˆç¯€é»
        class DirectoryComposite extends SystemEntryComponent {
            constructor(name) {
                super(name);
                this.children = [];
            }
            get type() { return "ç›®éŒ„"; }
            
            add(child) { this.children.push(child); }
            remove(childId) { this.children = this.children.filter(c => c.id !== childId); }
            getChildren() { return this.children; }

            accept(visitor) {
                visitor.visit(this);
                if (visitor instanceof DisplayVisitor || visitor instanceof XMLExportVisitor) {
                    visitor.increaseDepth();
                    this.children.forEach(child => child.accept(visitor));
                    visitor.decreaseDepth();
                } else {
                    this.children.forEach(child => child.accept(visitor));
                }
            }
        }

        // ========== è¨ªå•è€…æ¥å£èˆ‡å¯¦ç¾ ==========
        class IVisitor {
            visit(element) { throw new Error("Method not implemented."); }
        }

        // è¨ˆç®—ç¸½å¤§å°è¨ªå•è€…
        class SizeCalculatorVisitor extends IVisitor {
            constructor() {
                super();
                this.totalSize = 0;
            }
            visit(element) {
                if (element instanceof FileLeaf) {
                    this.totalSize += element.size;
                }
            }
            getTotalSize() { return this.totalSize; }
        }

        // æ–‡ä»¶æœå°‹è¨ªå•è€…
        class FileSearchVisitor extends IVisitor {
            constructor(extension) {
                super();
                this.extension = extension.toLowerCase();
                this.results = [];
            }
            visit(element) {
                if (element instanceof FileLeaf && element.name.toLowerCase().endsWith(this.extension)) {
                    this.results.push(element);
                }
            }
            getResults() { return this.results; }
        }

        // æ–‡æœ¬é¡¯ç¤ºè¨ªå•è€…ï¼ˆç”¨æ–¼çµ‚ç«¯è¼¸å‡ºï¼‰
        class DisplayVisitor extends IVisitor {
            constructor() {
                super();
                this.output = "";
                this.depth = 0;
                this.isRoot = true;
            }
            visit(element) {
                const indent = "  ".repeat(this.depth);
                if (element instanceof DirectoryComposite) {
                    if (!this.isRoot) {
                        this.output += `${indent}ğŸ“ ${element.name}\n`;
                    }
                    this.isRoot = false;
                } else if (element instanceof WordDocumentLeaf) {
                    this.output += `${indent}ğŸ“„ ${element.name} (Word, ${element.pages}p, ${element.getSizeDisplay()})\n`;
                } else if (element instanceof ImageFileLeaf) {
                    this.output += `${indent}ğŸ–¼ï¸ ${element.name} (Img, ${element.width}x${element.height}, ${element.getSizeDisplay()})\n`;
                } else if (element instanceof TextFileLeaf) {
                    this.output += `${indent}ğŸ“„ ${element.name} (Txt, ${element.encoding}, ${element.getSizeDisplay()})\n`;
                }
            }
            increaseDepth() { this.depth++; }
            decreaseDepth() { if (this.depth > 0) this.depth--; }
            getOutput() { return this.output; }
        }

        // XML åŒ¯å‡ºè¨ªå•è€…
        class XMLExportVisitor extends IVisitor {
            constructor() {
                super();
                this.xmlOutput = "";
                this.depth = 0;
                this.isRoot = true;
            }
            visit(element) {
                const indent = "  ".repeat(this.depth);
                if (element instanceof DirectoryComposite) {
                    if (!this.isRoot) {
                        this.xmlOutput += `${indent}<${element.name} type="ç›®éŒ„">\n`;
                    }
                    this.isRoot = false;
                } else if (element instanceof FileLeaf) {
                    this.xmlOutput += `${indent}<${element.name} type="${element.type}"></${element.name}>\n`;
                }
            }
            increaseDepth() { this.depth++; }
            decreaseDepth() { 
                if (this.depth > 0) {
                    this.depth--;
                }
            }
            afterChildren(element) {
                if (element instanceof DirectoryComposite && !this.isRoot) {
                    const indent = "  ".repeat(this.depth);
                    this.xmlOutput += `${indent}</${element.name}>\n`;
                }
            }
            getXMLOutput() { return this.xmlOutput; }
        }

        // ========== å…¨åŸŸç‹€æ…‹èˆ‡åŠŸèƒ½å¯¦ä½œ ==========
        let systemRoot = new DirectoryComposite("æ ¹ç›®éŒ„(Root)");
        let folderMap = new Map();

        function showTotalSize() {
            const visitor = new SizeCalculatorVisitor();
            systemRoot.accept(visitor);
            const total = visitor.getTotalSize();
            const formatted = total >= 1048576 ? (total/1048576).toFixed(2) + " MB" : (total/1024).toFixed(1) + " KB";
            document.getElementById('terminal-title').innerText = "é€²éšåˆ†æï¼šè¨ˆç®—ç¸½å¤§å°";
            document.getElementById('terminal-output').innerText = `ç³»çµ±å…§æ‰€æœ‰æª”æ¡ˆä¹‹ç¸½å¤§å°ç‚ºï¼š\n------------------------\n${total} Bytes\nç´„ç­‰åŒæ–¼ ${formatted}`;
        }

        function findDocxFiles() {
            const visitor = new FileSearchVisitor(".docx");
            systemRoot.accept(visitor);
            const files = visitor.getResults();
            document.getElementById('terminal-title').innerText = "é€²éšåˆ†æï¼šæœå°‹ .docx æª”æ¡ˆ";
            if (files.length === 0) {
                document.getElementById('terminal-output').innerText = "ç³»çµ±å…§ç›®å‰æ²’æœ‰å‰¯æª”åç‚º .docx çš„æª”æ¡ˆã€‚";
            } else {
                let res = `å…±å°‹ç² ${files.length} å€‹ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆï¼š\n------------------------\n`;
                files.forEach(f => res += `- ${f.name} (${f.getSizeDisplay()})\n`);
                document.getElementById('terminal-output').innerText = res;
            }
        }

        function exportToXML() {
            const visitor = new XMLExportVisitor();
            systemRoot.accept(visitor);
            // è£œä¸Šæ ¹ç›®éŒ„çš„closing tag
            const output = visitor.getXMLOutput();
            document.getElementById('terminal-title').innerText = "é€²éšåˆ†æï¼šXML æ ¼å¼åŒ¯å‡º";
            document.getElementById('terminal-output').innerText = output;
        }

        // ========== UI æ§åˆ¶ ==========
        function openTab(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            const activeTab = document.getElementById(tabName);
            activeTab.classList.add("active");
            evt.currentTarget.classList.add("active");

            if (tabName === 'domain' || tabName === 'er') {
                const diagrams = activeTab.querySelectorAll('.mermaid');
                diagrams.forEach(d => {
                    const code = d.getAttribute('data-original-code');
                    if (code) { d.innerHTML = code; d.removeAttribute('data-processed'); }
                });
                setTimeout(() => mermaid.run({ nodes: diagrams }), 50);
            }
        }

        function toggleFields() {
            const type = document.getElementById('type-select').value;
            const extra = document.getElementById('extra-fields');
            document.querySelectorAll("#extra-fields > div").forEach(d => d.classList.add('hidden'));

            if (type === 'FOLDER') { extra.classList.add('hidden'); } 
            else {
                extra.classList.remove('hidden');
                document.getElementById('node-size').parentElement.classList.remove('hidden');
                if (type === 'WORD') document.getElementById('field-pages').classList.remove('hidden');
                if (type === 'IMAGE') { document.getElementById('field-width').classList.remove('hidden'); document.getElementById('field-height').classList.remove('hidden'); }
                if (type === 'TEXT') document.getElementById('field-encoding').classList.remove('hidden');
            }
        }

        function handleAddNode() {
            const pId = document.getElementById('parent-select').value;
            const type = document.getElementById('type-select').value;
            const name = document.getElementById('node-name').value || "æœªå‘½å";
            const parent = folderMap.get(pId);
            if (!parent) return;

            let node;
            const size = parseInt(document.getElementById('node-size').value);
            if (type === 'FOLDER') {
                node = new DirectoryComposite(name);
            } else if (type === 'WORD') {
                node = new WordDocumentLeaf(name, size, parseInt(document.getElementById('node-pages').value));
            } else if (type === 'IMAGE') {
                node = new ImageFileLeaf(name, size, parseInt(document.getElementById('node-width').value), parseInt(document.getElementById('node-height').value));
            } else if (type === 'TEXT') {
                node = new TextFileLeaf(name, size, document.getElementById('node-encoding').value);
            }

            parent.add(node);
            refreshUI();
            document.getElementById('node-name').value = "";
        }

        function handleDeleteNode(id) {
            if (id === systemRoot.id) return;
            function search(curr) {
                const startLen = curr.getChildren().length;
                curr.remove(id);
                if (curr.getChildren().length < startLen) return true;
                for (let c of curr.getChildren()) {
                    if (c instanceof DirectoryComposite && search(c)) return true;
                }
                return false;
            }
            search(systemRoot);
            refreshUI();
        }

        function refreshUI() {
            const displayVisitor = new DisplayVisitor();
            systemRoot.accept(displayVisitor);
            document.getElementById('terminal-title').innerText = "çµ‚ç«¯æ©Ÿè¼¸å‡º (çµæ§‹æª¢è¦–)";
            document.getElementById('terminal-output').innerText = displayVisitor.getOutput();
            const tree = document.getElementById('tree-visual');
            tree.innerHTML = "";
            renderVisual(systemRoot, tree);
            updateSelect();
        }

        function renderVisual(node, container) {
            const row = document.createElement('div');
            row.className = "tree-item-row flex items-center group py-1";
            const content = document.createElement('div');
            content.className = "flex-grow flex items-center";
            let html = "";
            
            if (node instanceof DirectoryComposite) {
                html = `<span class="folder-icon font-bold mr-1">ğŸ“ ${node.name}</span>`;
            } else if (node instanceof WordDocumentLeaf) {
                html = `<span class="file-icon mr-1">ğŸ“„ ${node.name}</span> <span class="text-xs text-gray-400">(Word, ${node.pages}p, ${node.getSizeDisplay()})</span>`;
            } else if (node instanceof ImageFileLeaf) {
                html = `<span class="file-icon mr-1">ğŸ–¼ï¸ ${node.name}</span> <span class="text-xs text-gray-400">(Img, ${node.width}x${node.height}, ${node.getSizeDisplay()})</span>`;
            } else if (node instanceof TextFileLeaf) {
                html = `<span class="file-icon mr-1">ğŸ“„ ${node.name}</span> <span class="text-xs text-gray-400">(Txt, ${node.encoding}, ${node.getSizeDisplay()})</span>`;
            }
            
            content.innerHTML = html;
            row.appendChild(content);
            if (node.id !== systemRoot.id) {
                const btn = document.createElement('button');
                btn.className = "delete-btn text-red-500 text-xs ml-2 font-bold px-1";
                btn.innerHTML = "ğŸ—‘ï¸";
                btn.onclick = (e) => { e.stopPropagation(); handleDeleteNode(node.id); };
                row.appendChild(btn);
            }
            const wrap = document.createElement('div');
            wrap.className = "tree-node";
            wrap.appendChild(row);
            container.appendChild(wrap);
            if (node instanceof DirectoryComposite) {
                node.getChildren().forEach(c => renderVisual(c, wrap));
            }
        }

        function updateSelect() {
            const select = document.getElementById('parent-select');
            const curr = select.value;
            select.innerHTML = "";
            folderMap.clear();
            function walk(n, path = "") {
                if (n instanceof DirectoryComposite) {
                    const p = path + "/" + n.name;
                    folderMap.set(n.id, n);
                    const o = document.createElement('option');
                    o.value = n.id; o.innerText = p;
                    select.appendChild(o);
                    n.getChildren().forEach(c => walk(c, p));
                }
            }
            walk(systemRoot);
            if (folderMap.has(curr)) select.value = curr;
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.mermaid').forEach(d => d.setAttribute('data-original-code', d.innerText.trim()));
            
            // åˆå§‹åŒ–çµæ§‹
            const project = new DirectoryComposite("å°ˆæ¡ˆæ–‡ä»¶ (Project_Docs)");
            project.add(new WordDocumentLeaf("éœ€æ±‚è¦æ ¼æ›¸.docx", 500 * 1024, 15));
            project.add(new ImageFileLeaf("ç³»çµ±æ¶æ§‹åœ–.png", 2 * 1024 * 1024, 1920, 1080));

            const personal = new DirectoryComposite("å€‹äººç­†è¨˜ (Personal_Notes)");
            personal.add(new TextFileLeaf("å¾…è¾¦æ¸…å–®.txt", 1 * 1024, "UTF-8"));
            
            const archive = new DirectoryComposite("2025å‚™ä»½ (Archive_2025)");
            archive.add(new WordDocumentLeaf("èˆŠæœƒè­°è¨˜éŒ„.docx", 200 * 1024, 5));
            personal.add(archive);
            
            systemRoot.add(project);
            systemRoot.add(personal);
            systemRoot.add(new TextFileLeaf("README.txt", 500, "ASCII"));

            refreshUI();
            toggleFields();
        });
    </script>
</body>
</html>